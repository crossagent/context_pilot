services:
  app:
    build: .
    ports:
      # Host:Container
      - "54089:8000"

    volumes:
      # Mount project code into container
      - .:/app
      # [CRITICAL] Mount the actual source code repository from the host machine.
      # The repo_explorer_agent runs on the host and accesses files directly,
      # so this volume is NOT needed for file exploration.
      # Only needed if you want the container itself to reference source paths.
      # - "C:/path/to/your/project:/project_root"

    environment:
      # Inject Docker-specific routing URLs.
      # Because .env is read by Python (via load_dotenv), we avoid defining these URLs in .env 
      # so that these hardcoded environment overrides take precedence inside the container.
      - PROJECT_ROOT=/project_root
      - PYTHONPATH=/app
      - ADK_DATA_DIR=/app/adk_data
      - PYTHONUNBUFFERED=1
      # Remote A2A Agent URLs
      # planning_expert runs in Docker (same Docker network, use service name as hostname)
      - PLANNING_EXPERT_URL=http://planning_expert:8001
      # repo_explorer runs on the Windows host machine (needs local file system access)
      # host.docker.internal is supported natively by Docker Desktop on Windows
      - REPO_EXPLORER_URL=http://host.docker.internal:8002
    depends_on:
      - planning_expert
    restart: unless-stopped

  planning_expert:
    build: .
    ports:
      - "8001:8001"
    volumes:
      - .:/app
    environment:
      - PYTHONPATH=/app
      - PYTHONUNBUFFERED=1
      - RAG_STORAGE_DIR=/app/adk_data/rag_storage
      - A2A_HOST=planning_expert
    # Override the default CMD to start the planning_expert A2A server instead
    command: >
      python -m uvicorn context_pilot.context_pilot_app.remote_a2a.planning_expert_agent.agent:app --host 0.0.0.0 --port 8001
    restart: unless-stopped
